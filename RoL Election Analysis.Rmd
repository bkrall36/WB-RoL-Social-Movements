---
title: "RoL Election Analysis"
author: "Brendon Krall"
date: "8/8/2022"
output: html_document
---

# Enviroment Setup
```{r, Housekeeping, message=FALSE, warning=FALSE}
rm(list=ls()) # Clear working memory 
library(readxl) # Load Excel files
library(magrittr) # Make all colnames lower case with no spaces
library(stringr) # String formatting and replacement
library(dplyr) # Data wrangling and manipulation
library(ggplot2) # Data visualization
library(tidyr) # Nesting and unnesting dataframes
library(purrr) # Map all function
library(broom) # Multiple linear regressions
library(lmtest) # Run linear regressions with robust standard errors 
library(multiwayvcov) # Generate robust standard 
library(sandwich) # Generate robust standard errors
library(stargazer) # Good way to report regression reports
```

# Data Import
```{r, message=FALSE, warning=FALSE}
setwd("C:/Users/brend/OneDrive/Documents/GitHub/WB-RoL-Social-Movements")
df <- read_excel("Elections_Final_10.08.xlsx", sheet = 1)
```

# Prepare Linear Regression Model Terms and Dummy Variables
```{r}
# Create Year Fixed-Effect Variable 
df$year_dummy <- factor(df$Year)

# Create Constituency Fixed-Effect Variable 
df$constituency_dummy <- factor(df$`PA ID`)

# Create Treated 2008 and 2013 variable
df <- df %>% mutate(
  treated = ifelse((`1st_visit_year`<= Year), 1, 0)
)

# Create Visits 2008 and 2013 variable Counts
#df <- df %>% mutate(
#  treated_2008_n = ifelse((Year == 2008 & Treated == 1), 'Visits before 2008 elections', 0),
#  treated_2013_n = ifelse((Year == 2013 & Treated == 1), 'N_visits', 0)
#)

# Remove observations with NA values for our outcome variable 
df <- df %>% filter(!is.na(Vote_Share))
```
# Subset Dataset for Regression Analysis
```{r}
# Restrict analysis to years between 2002 and 2008
df_02_08 <- df %>%
  filter(Year >= 2002 & Year <= 2008)

# Subset data by party affiliation 
df_pml <- df_02_08 %>%
  filter(`Party Initials` == 'PML')

df_pml_n <- df_02_08 %>%
  filter(`Party Initials` == 'PML-N')

df_pppp <- df_02_08 %>%
  filter(`Party Initials` == 'PPPP')
```


# Perform Regression Analysis - PML
```{r}
# OLS 
reg_pml <- lm(Vote_Share.1 ~ treated, data = df_pml)
# cluster-robust SEs for reg_pml
cl.cov.pml1 <- cluster.vcov(reg_pml, df_pml$`PA ID`) 
cl.robust.se.pml1 <- sqrt(diag(cl.cov.pml1))

# OLS with 'count' variable control
reg_pml2 <- lm(Vote_Share.1 ~ treated + count, data = df_pml)
# cluster-robust SEs for reg_pml2
cl.cov.pml2 <- cluster.vcov(reg_pml2, df_pml$`PA ID`) 
cl.robust.se.pml2 <- sqrt(diag(cl.cov.pml2))

# OLS with TWFE 
reg_pml3 <- lm(Vote_Share.1 ~ treated + year_dummy + constituency_dummy, data = df_pml)
# cluster-robust SEs for reg_pml3
cl.cov.pml3 <- cluster.vcov(reg_pml3, df_pml$`PA ID`) 
cl.robust.se.pml3 <- sqrt(diag(cl.cov.pml3))

# OLS with TWFE + 'count' control variable 
reg_pml4 <- lm(Vote_Share.1 ~ treated + year_dummy + constituency_dummy + count, data = df_pml)
# cluster-robust SEs for reg_pml4
cl.cov.pml4 <- cluster.vcov(reg_pml4, df_pml$`PA ID`) 
cl.robust.se.pml4 <- sqrt(diag(cl.cov.pml4))

stargazer(reg_pml,reg_pml2,reg_pml3,reg_pml4, type="text", title="Effect of CJ visits on vote share for General Musharraf PML - Impact on Dicatorâ€™s Party", keep = c('Constant','treated', 'count', 'year_dummy2008'), order=c('Constant','treated'), covariate.labels=c('Unvisited Districts', 'Visited Districts', 'Controls', 'Year Dummy (2008)'), column.labels=c('OLS', 'OLS w/ Controls', 'FE', 'FE w/ Controls'), dep.var.labels='Vote Share for PML Party', se = list(cl.robust.se.pml1, cl.robust.se.pml2, cl.robust.se.pml3, cl.robust.se.pml4), notes = c("Robust standard errors appear in brackets (clustered at the district level).",  "The table presents DiD estimation of the effect of Chief Justice visits to districts of", "Pakistan before 2008 elections on the share of votes in favour of PML party in 2008 provincial", "and national elections (compare to 2002 elections). Outcome variable is visit to a given",  "district. Controls include: # of candidates in a district (count)."), notes.align = "l")
```

# Perform Regression Analysis - PML-N
```{r}
# OLS 
reg_pmln <- lm(Vote_Share.1 ~ treated, data = df_pml_n)
# cluster-robust SEs for reg_pmln
cl.cov.pmln1 <- cluster.vcov(reg_pmln, df_pml_n$`PA ID`) 
cl.robust.se.pmln1 <- sqrt(diag(cl.cov.pmln1))

# OLS with 'count' variable control
reg_pmln2 <- lm(Vote_Share.1 ~ treated + count, data = df_pml_n)
# cluster-robust SEs for reg_pmln2
cl.cov.pmln2 <- cluster.vcov(reg_pmln2, df_pml_n$`PA ID`) 
cl.robust.se.pmln2 <- sqrt(diag(cl.cov.pmln2))

# OLS with TWFE 
reg_pmln3 <- lm(Vote_Share.1 ~ treated + year_dummy + constituency_dummy, data = df_pml_n)
# cluster-robust SEs for reg_pmln3
cl.cov.pmln3 <- cluster.vcov(reg_pmln3, df_pml_n$`PA ID`) 
cl.robust.se.pmln3 <- sqrt(diag(cl.cov.pmln3))

# OLS with TWFE + 'count' control variable 
reg_pmln4 <- lm(Vote_Share.1 ~ treated + year_dummy + constituency_dummy + count, data = df_pml_n)
# cluster-robust SEs for reg_pmln4
cl.cov.pmln4 <- cluster.vcov(reg_pmln4, df_pml_n$`PA ID`) 
cl.robust.se.pmln4 <- sqrt(diag(cl.cov.pmln4))

stargazer(reg_pmln,reg_pmln2,reg_pmln3,reg_pmln4, type="text", title='Effect of CJ visits on vote share for Opposition Party Pledging Supporting for the Lawyers Movement (PML-N) - Impact on Pro-Lawyers Movement Party', keep = c('Constant','treated', 'count', 'year_dummy2008'), order=c('Constant','treated'), covariate.labels=c('Unvisited Districts', 'Visited Districts', 'Controls', 'Year Dummy (2008)'), column.labels=c('OLS', 'OLS w/ Controls', 'FE', 'FE w/ Controls'), dep.var.labels='Vote Share for PML-N Party', se = list(cl.robust.se.pmln1, cl.robust.se.pmln2, cl.robust.se.pmln3, cl.robust.se.pmln4), notes = c("Robust standard errors appear in brackets (clustered at the district level).",  "The table presents DiD estimation of the effect of Chief Justice visits to districts of", "Pakistan before 2008 elections on the share of votes in favour of PML-N party in 2008", "provincial and national elections (compare to 2002 elections). Outcome variable is visit to a", "given district. Controls include: # of candidates in a district (count)."), notes.align = "l")
```

# Perform Regression Analysis - PPPP
```{r}
# OLS 
reg_pppp <- lm(Vote_Share.1 ~ treated, data = df_pppp)
# cluster-robust SEs for reg_pppp
cl.cov.pppp1 <- cluster.vcov(reg_pppp, df_pppp$`PA ID`) 
cl.robust.se.pppp1 <- sqrt(diag(cl.cov.pppp1))

# OLS with 'count' variable control
reg_pppp2 <- lm(Vote_Share.1 ~ treated + count, data = df_pppp)
# cluster-robust SEs for reg_pppp2
cl.cov.pppp2 <- cluster.vcov(reg_pppp2, df_pppp$`PA ID`) 
cl.robust.se.pppp2 <- sqrt(diag(cl.cov.pppp2))

# OLS with TWFE 
reg_pppp3 <- lm(Vote_Share.1 ~ treated + year_dummy + constituency_dummy, data = df_pppp)
# cluster-robust SEs for reg_pppp3
cl.cov.pppp3 <- cluster.vcov(reg_pppp3, df_pppp$`PA ID`) 
cl.robust.se.pppp3 <- sqrt(diag(cl.cov.pppp3))

# OLS with TWFE + 'count' control variable 
reg_pppp4 <- lm(Vote_Share.1 ~ treated + year_dummy + constituency_dummy + count, data = df_pppp)
# cluster-robust SEs for reg_pppp4
cl.cov.pppp4 <- cluster.vcov(reg_pppp4, df_pppp$`PA ID`) 
cl.robust.se.pppp4 <- sqrt(diag(cl.cov.pppp4))

stargazer(reg_pppp,reg_pppp2,reg_pppp3,reg_pppp4, type="text", title="Effect of CJ visits on vote share for the non-supporting Lawyers movement opposition (PPP) - Impact on the non-aligned Opposition", keep = c('Constant','treated', 'count', 'year_dummy2008'), order=c('Constant','treated'), covariate.labels=c('Unvisited Districts', 'Visited Districts', 'Controls', 'Year Dummy (2008)'), column.labels=c('OLS', 'OLS w/ Controls', 'FE', 'FE w/ Controls'), dep.var.labels='Vote Share for PPPP Party', se = list(cl.robust.se.pppp1, cl.robust.se.pppp2, cl.robust.se.pppp3, cl.robust.se.pppp4), notes = c("Robust standard errors appear in brackets (clustered at the district level).",  "The table presents DiD estimation of the effect of Chief Justice visits to districts of", "Pakistan before 2008 elections on the share of votes in favour of PPP party in 2008 provincial", "and national elections (compare to 2002 elections). Outcome variable is visit to a given",  "district. Controls include: # of candidates in a district (count)."), notes.align = "l")
```

# Difference in Means of Vote Share PML Summary Table
```{r, message=FALSE}
# Summarize and save as a table to graph 
pml_table <- df_02_08 %>% 
  filter((Year == 2002 | 2008), `Party Initials` == 'PML') %>%
  group_by(Year,`Treated before 2008 elections`) %>%
  summarize(
    'Percentage of Vote Share' = mean(Vote_Share.1)
)

# Reshape the table to wide format
pml_table <- spread(pml_table, key = "Treated before 2008 elections", value = 'Percentage of Vote Share')

# Transpose the table, remove the first row, and save as df object
pml_table <- t(pml_table)
pml_table <- pml_table[-1,]
pml_table <- as.data.frame(pml_table)

# Create a difference column
pml_table <- pml_table %>%
  mutate(
    Difference = pml_table$V2 - pml_table$V1
)

# Rename columns and rows
colnames(pml_table) <- c(2002, 2008, 'Difference')
rownames(pml_table) <- c("Unvisited Districts", "Visited Districts")

print(pml_table)
```

# Difference in Means of Vote Share PML-N
```{r, message=FALSE}
pmln_table <- df_02_08 %>% 
  filter((Year == 2002 | 2008), `Party Initials` == 'PML-N') %>%
  group_by(Year,`Treated before 2008 elections`) %>%
  summarize(
    'Percentage of Vote Share' = mean(Vote_Share.1)
)

# Reshape the table to wide format
pmln_table <- spread(pmln_table, key = "Treated before 2008 elections", value = 'Percentage of Vote Share')

# Transpose the table, remove the first row, and save as df object
pmln_table <- t(pmln_table)
pmln_table <- pmln_table[-1,]
pmln_table <- as.data.frame(pmln_table)

# Create a difference column
pmln_table <- pmln_table %>%
  mutate(
    Difference = pmln_table$V2 - pmln_table$V1
)

# Rename columns and rows
colnames(pmln_table) <- c(2002, 2008, 'Difference')
rownames(pmln_table) <- c("Unvisited Districts", "Visited Districts")

print(pmln_table)
```

# Difference in Means of Vote Share PPPP
```{r, message=FALSE}
pppp_table <- df_02_08 %>% 
  filter((Year == 2002 | 2008), `Party Initials` == 'PPPP') %>%
  group_by(Year,`Treated before 2008 elections`) %>%
  summarize(
    'Percentage of Vote Share' = mean(Vote_Share.1)
)

# Reshape the table to wide format
pppp_table <- spread(pppp_table, key = "Treated before 2008 elections", value = 'Percentage of Vote Share')

# Transpose the table, remove the first row, and save as df object
pppp_table <- t(pppp_table)
pppp_table <- pppp_table[-1,]
pppp_table <- as.data.frame(pppp_table)

# Create a difference column
pppp_table <- pppp_table %>%
  mutate(
    Difference = pppp_table$V2 - pppp_table$V1
)

# Rename columns and rows
colnames(pppp_table) <- c(2002, 2008, 'Difference')
rownames(pppp_table) <- c("Unvisited Districts", "Visited Districts")

print(pppp_table)
```

# Parallel Trend Graphs
```{r, warning=FALSE}
# Subset data for ease of manipulation
df_subset <- df %>% select(c(Year, Vote_Share.1, 'Party Initials', Treated))

# Rename for clarity
df_subset <- df_subset %>%
  mutate(
    Treated = ifelse(Treated == 1, 'Visited Districts', 'Unvisited Districts')
)

# Parallel Trend for PML                    
df_subset %>%
  filter(`Party Initials` == 'PML') %>%
  ggplot(aes(x = Year, y = Vote_Share.1, color = Treated)) +
  stat_summary(fun.y = mean, geom = 'line', size = 1.25) +
  theme_bw() +
  labs(x = "Year", y = "% of Vote Share", title = "Change in Percentage of Vote Share PML (Years 1970 to 2012)") +
  geom_vline(xintercept = 2007)

# Parallel Trend for PML-N                   
df_subset %>%
  filter(`Party Initials` == 'PML-N') %>%
  ggplot(aes(x = Year, y = Vote_Share.1, color = Treated)) +
  stat_summary(fun.y = mean, geom = 'line', size = 1.25) +
  theme_bw() +
  labs(x = "Year", y = "% of Vote Share", title = "Change in Percentage of Vote Share PML-N (Years 1992 to 2012)") +
  geom_vline(xintercept = 2007)

# Parallel Trend for PPPP                    
df_subset %>%
  filter(`Party Initials` == 'PPPP') %>%
  ggplot(aes(x = Year, y = Vote_Share.1, color = Treated)) +
  stat_summary(fun.y = mean, geom = 'line', size = 1.25) +
  theme_bw() +
  labs(x = "Year", y = "% of Vote Share", title = "Change in Percentage of Vote Share PPPP (Years 2002 to 2012)") +
  geom_vline(xintercept = 2007)
```

# Event Study 
```{r}
# Construct a variable that, for treated units, will take the value of the 
# number of years leading up to it (+3,-3). For untreated units, or treated 
# units that will be treated 3 or more years in the future,it takes the value -4
df$time_since_treatment = ifelse(!is.na(df$`1st_visit_year`) & (df$Year-df$`1st_visit_year`>=-3) & (df$Year-df$`1st_visit_year`<=3),df$Year-df$`1st_visit_year`,-4)
# For treated units, after 3 years, this variable will have the value 4
df$time_since_treatment = ifelse(!is.na(df$`1st_visit_year`) & (df$Year-df$`1st_visit_year`>3),4,df$time_since_treatment)

event_study_reg <- lm(Vote_Share.1 ~ factor(time_since_treatment) + constituency_dummy + year_dummy + count, data = df)

# cluster-robust SEs for event study
cl.cov.event <- cluster.vcov(event_study_reg, df$`PA ID`) 
cl.robust.se.event <- sqrt(diag(cl.cov.event))

stargazer(event_study_reg, type="text", keep=c("Constant","time_since_treatment"), se = list(cl.robust.se.event), notes = c("Robust standard errors appear in brackets (clustered at the district level)."), notes.align = "l")
```

```{r}
# Store the beta coefficients as X and Y pairs for plotting 
summary <- as.data.frame(event_study_reg$coefficients)
y <- as.data.frame(summary[2:4,])
x <- as.data.frame(c(-1, 0, 1))

# Generate CI at 95% level for time_since_treatment variable
cis <- confint(event_study_reg, level=0.95)
cis <- cis[2:4, ]

# Create dataframe for plotting
combined_df <- cbind(x, y, cis)

ggplot(combined_df, aes(x=`c(-1, 0, 1)`, y=`summary[2:4, ]`)) +
  geom_pointrange(aes(ymin=`2.5 %`, ymax=`97.5 %`)) +
  labs(x='Time to Treatment (years)', y='Effect Size (pp of Vote Share)', title='Average Treatment Effect of CJ Visit') +
  geom_line() +
  theme_bw()
```